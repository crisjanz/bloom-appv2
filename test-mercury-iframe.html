<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mercury HQ iframe Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    .test-info {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #597485;
    }

    .test-info h2 {
      color: #597485;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .test-info p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .test-info code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }

    .status {
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .iframe-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    iframe {
      width: 100%;
      height: 800px;
      border: 2px solid #ddd;
      border-radius: 4px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 10px 20px;
      background: #597485;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #4a5f6e;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #token-result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Mercury HQ iframe Embedding Test</h1>

    <div class="test-info">
      <h2>What This Tests:</h2>
      <p>1. <strong>Can Mercury HQ be embedded in an iframe?</strong> (Checks for X-Frame-Options blocking)</p>
      <p>2. <strong>Can we access localStorage from iframe?</strong> (Checks for CORS/same-origin policy)</p>
      <p>3. <strong>Can we extract the auth token?</strong> (Checks if token exists in storage)</p>
    </div>

    <div id="status" class="status pending">
      ‚è≥ Waiting for iframe to load...
    </div>

    <div class="iframe-container">
      <iframe
        id="mercury-iframe"
        src="https://mercuryhq.com/orders"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
      ></iframe>

      <div class="buttons">
        <button onclick="testIframeAccess()">Test iframe Access</button>
        <button onclick="extractToken()">Extract Token</button>
        <button onclick="testStorage()">Test Storage Access</button>
        <button onclick="location.reload()">Reload Test</button>
      </div>

      <div id="token-result"></div>
    </div>
  </div>

  <script>
    const iframe = document.getElementById('mercury-iframe');
    const statusDiv = document.getElementById('status');
    const tokenResult = document.getElementById('token-result');

    // Track iframe load
    iframe.addEventListener('load', () => {
      console.log('‚úÖ iframe loaded successfully');
      updateStatus('success', '‚úÖ iframe loaded! Mercury HQ does NOT block iframe embedding.');
    });

    iframe.addEventListener('error', () => {
      console.error('‚ùå iframe failed to load');
      updateStatus('error', '‚ùå iframe failed to load. Mercury HQ likely blocks iframe embedding (X-Frame-Options).');
    });

    function updateStatus(type, message) {
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }

    function testIframeAccess() {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDocument = iframe.contentDocument;

        if (iframeWindow && iframeDocument) {
          console.log('‚úÖ Can access iframe window and document');
          updateStatus('success', '‚úÖ Can access iframe! Same-origin policy allows access.');
          showResult('‚úÖ iframe Access: SUCCESS\n\nCan access contentWindow and contentDocument.');
        } else {
          throw new Error('Cannot access iframe');
        }
      } catch (error) {
        console.error('‚ùå Cannot access iframe:', error);
        updateStatus('error', '‚ùå Cannot access iframe. Same-origin policy blocks access.');
        showResult(`‚ùå iframe Access: BLOCKED\n\nError: ${error.message}\n\nThis means we cannot extract data from iframe.`);
      }
    }

    function extractToken() {
      try {
        const iframeWindow = iframe.contentWindow;

        // Try localStorage
        const token = iframeWindow.localStorage.getItem('ep-authorization');

        if (token) {
          console.log('‚úÖ Token extracted:', token);
          updateStatus('success', '‚úÖ Token extracted successfully!');
          showResult(`‚úÖ Token Extraction: SUCCESS\n\nToken: ${token}\n\nYou can use this token in your Bloom app!`);
        } else {
          // Try sessionStorage
          const sessionToken = iframeWindow.sessionStorage.getItem('ep-authorization');
          if (sessionToken) {
            console.log('‚úÖ Token found in sessionStorage:', sessionToken);
            updateStatus('success', '‚úÖ Token found in sessionStorage!');
            showResult(`‚úÖ Token Extraction: SUCCESS (sessionStorage)\n\nToken: ${sessionToken}`);
          } else {
            updateStatus('error', '‚ö†Ô∏è No token found in storage. Make sure you\'re logged into Mercury HQ.');
            showResult('‚ö†Ô∏è Token Extraction: NO TOKEN FOUND\n\nPossible reasons:\n1. Not logged into Mercury HQ\n2. Token stored with different key\n3. Token in cookies instead of storage');
          }
        }
      } catch (error) {
        console.error('‚ùå Cannot extract token:', error);
        updateStatus('error', '‚ùå Cannot extract token. CORS/Same-origin policy blocks access.');
        showResult(`‚ùå Token Extraction: BLOCKED\n\nError: ${error.message}\n\nThis confirms we CANNOT extract tokens from iframe due to security restrictions.`);
      }
    }

    function testStorage() {
      try {
        const iframeWindow = iframe.contentWindow;

        // List all localStorage keys
        const localKeys = Object.keys(iframeWindow.localStorage);
        const sessionKeys = Object.keys(iframeWindow.sessionStorage);

        console.log('localStorage keys:', localKeys);
        console.log('sessionStorage keys:', sessionKeys);

        let result = '‚úÖ Storage Access: SUCCESS\n\n';
        result += `localStorage keys (${localKeys.length}):\n${localKeys.join('\n') || '(empty)'}\n\n`;
        result += `sessionStorage keys (${sessionKeys.length}):\n${sessionKeys.join('\n') || '(empty)'}`;

        updateStatus('success', '‚úÖ Can access iframe storage!');
        showResult(result);
      } catch (error) {
        console.error('‚ùå Cannot access storage:', error);
        updateStatus('error', '‚ùå Cannot access storage. CORS blocks access.');
        showResult(`‚ùå Storage Access: BLOCKED\n\nError: ${error.message}\n\nüö´ This confirms iframe token extraction will NOT work.`);
      }
    }

    function showResult(text) {
      tokenResult.style.display = 'block';
      tokenResult.textContent = text;
    }

    // Auto-test on load (with delay to let iframe load)
    setTimeout(() => {
      console.log('Running auto-test...');
      testIframeAccess();
    }, 3000);
  </script>
</body>
</html>
