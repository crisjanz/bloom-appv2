# Bloom Flower Shop â€“ Progress Tracker

**Last audited:** 2026-01-17
Status markers: âœ… done Â· ğŸ› ï¸ in progress Â· ğŸ”œ planned Â· âš ï¸ attention

## âœ… Production-Ready
- âœ… **POS â†” Take Order transfer** â€” multi-order draft creation, PT number generation, and real-time POS cart sync (`admin/src/app/components/pos/TakeOrderOverlay.tsx`, `back/src/routes/orders/create.ts`).
- âœ… **Payment capture suite** â€” Cash, Stripe, Square, gift card, and offline tender flows organized under `PaymentController` (`admin/src/app/components/pos/payment/PaymentController.tsx`).
- âœ… **Customer & recipient migration** â€” single-source customer records with shared addresses and recipient links (`back/prisma/schema.prisma:328-386`, `admin/src/app/components/orders/RecipientCard.tsx`).
- âœ… **Gift card lifecycle** â€” batch generation, activation, redemption, and digital handoff (`back/src/routes/gift-cards`, `admin/src/app/components/orders/payment/GiftCardActivationModal.tsx`).
- âœ… **Unified discounts module** â€” `/api/discounts` powering POS auto-apply + manual overrides (`back/src/routes/discounts.ts`, `admin/src/domains/payments/hooks/usePaymentCalculations.ts`).
- âœ… **FTD monitor + dashboard** â€” token refresh, polling, order linking, and admin review pages (`back/src/services/ftdMonitor.ts`, `admin/src/app/pages/ftd`).
- âœ… **Payment settings admin** â€” encrypted provider credentials, offline tenders, and UI warnings when `CONFIG_ENCRYPTION_KEY` is absent (`admin/src/app/pages/settings/payments.tsx`, `back/src/routes/settings/payments.ts`).
- âœ… **Stripe credentials from DB** â€” Stripe client now loads from encrypted payment settings with cache invalidation after updates; `.env` Stripe keys removed in favor of Settings â†’ Payments (`back/src/services/paymentProviders/PaymentProviderFactory.ts`, `back/src/routes/stripe.ts`, `back/src/routes/settings/payments.ts`).
- âœ… **Order list + filters** â€” new `OrdersListPage` with status/date filters and pagination (`admin/src/app/pages/orders/OrdersListPage.tsx`, `back/src/routes/orders/list.ts`).
- âœ… **Homepage content management** â€” full CMS for announcement banner, hero banners (3), frequently sold products, seasonal collections (2), featured categories (4), and FAQ system with drag-reorder. Admin at Settings â†’ Website (`admin/src/app/components/settings/website/*`, `back/src/routes/settings/homepage.ts`, `back/src/routes/settings/faqs.ts`, `www/src/components/*`). Database models: `HomepageBanner`, `HomepageSettings`, `FAQ`.
- âœ… **Add-on products** â€” add-on groups managed under Settings â†’ Orders with product assignments, product form selection, and order add-on picker (`back/src/routes/addon-groups.ts`, `admin/src/app/components/settings/orders/AddOnGroupsCard.tsx`, `admin/src/app/components/products/ProductForm.tsx`, `admin/src/app/components/orders/ProductsCard.tsx`).
- âœ… **Dashboard metrics (2025-11-03)** â€” real-time operational dashboard with KPI cards and 7-day revenue trend chart. Shows today's revenue, pending orders (with overdue count), deliveries today by status, and new customers this week. Auto-refreshes every 5 minutes. Backend: `/back/src/routes/dashboard.ts` (2 endpoints: `/api/dashboard/metrics`, `/api/dashboard/revenue-trend`). Frontend: `/admin/src/shared/hooks/useDashboard.ts`, `/admin/src/app/components/dashboard/MetricCard.tsx`, `/admin/src/app/components/dashboard/RevenueTrendChart.tsx` (Recharts). Integrated into `/admin/src/app/pages/Dashboard/Home.tsx`.
- âœ… **Floranext recipient import** â€” Settings â†’ Misc CSV uploader builds recipient customer records, addresses, sender links, and detailed summaries with optional auto-customer creation (`back/src/routes/import.ts`, `admin/src/app/components/settings/misc/ImportCard.tsx`).
- âœ… **Print system** â€” Backend queue service, REST endpoints, WebSocket integration, and Windows Electron desktop agent for auto-printing order tickets, delivery slips, and receipts to thermal and standard printers (`back/src/prisma/schema.prisma`, `back/src/routes/print-jobs`, `back/src/services/printService.ts`, `bloom-print-agent/`). Order creation auto-triggers ticket printing. Agent includes signature capture for driver delivery slips. Docs updated in `docs/API_Endpoints.md` and `docs/System_Reference.md`.
- âœ… **Print settings & routing (2026-01-17)** â€” Configurable destinations per print type with browser fallback, printer/tray/copy settings, and agent filtering (`back/src/routes/print-settings`, `back/src/services/printSettingsService.ts`, `back/src/services/printService.ts`, `admin/src/app/pages/settings/print.tsx`, `bloom-print-agent/src/job-processor.ts`).
- âœ… **Print & email templates (2026-01-17)** â€” Email settings stored in DB with admin UI, PDF receipt/invoice generation, print/email endpoints, and POS/order print actions (`back/src/routes/print`, `back/src/routes/email/send.ts`, `back/src/routes/email-settings`, `back/src/services/emailService.ts`, `admin/src/app/pages/settings/email.tsx`, `admin/src/app/components/orders/ReceiptInvoiceModal.tsx`, `admin/src/app/components/pos/payment/PaymentController.tsx`).
- âœ… **Unified PDF print system with QR codes (2026-01-18)** â€” Order ticket PDFs now shared between browser and Electron with backend-generated QR codes, preview endpoint, and agent PDF payloads (`back/src/templates/order-ticket-pdf.ts`, `back/src/services/printService.ts`, `back/src/routes/print/index.ts`, `bloom-print-agent/src/job-processor.ts`, `admin/src/app/pages/settings/print.tsx`).
- âœ… **Windows receipt print agent (2026-01-18)** â€” Native .NET tray app for receipt-agent jobs with WebSocket connection, raw ESC/POS printing, settings UI, and logs (`receipt-print-agent/`).
- âœ… **Email & SMS settings integration (2026-01-17)** â€” Twilio credentials stored in DB with encryption, unified Email & SMS settings page, and SMS service backed by database configuration (`back/src/services/emailSettingsService.ts`, `back/src/services/smsService.ts`, `admin/src/app/pages/settings/email.tsx`).
- âœ… **Communications chat + incoming SMS (2026-01-18)** â€” Twilio inbound webhook with read tracking, chat-style timeline, unread badges on Delivery board + sidebar, and admin WebSocket updates (`back/src/routes/sms/webhook.ts`, `back/src/routes/communications.ts`, `back/src/routes/orders/delivery.ts`, `admin/src/app/components/delivery/CommunicationTimeline.tsx`, `admin/src/app/pages/delivery/DeliveryPage.tsx`, `admin/src/shared/ui/layout/AppSidebar.tsx`).
- âœ… **QR code delivery routes** â€” Added `Route`/`RouteStop` models + migration (`prisma/migrations/20251217015001_add_delivery_routes`), route management APIs (list/create/resequence/status/delete/update) at `/api/routes`, public driver view and proof-of-delivery endpoints under `/api/driver/*`, QR generation endpoint, admin Route Builder UI with drag-to-resequence and driver assignment (`admin/src/app/pages/delivery/RouteBuilderPage.tsx`, `admin/src/shared/hooks/useRoutes.ts`, `admin/src/app/App.tsx` link), and public driver page at `/driver/route` with signature capture (`www/src/pages/DriverRoute.jsx`, `www/src/routes/root.jsx`). Delivery tickets printed via the Electron print agent now include a "Scan for Route" QR code on the driver slip (`bloom-print-agent/src/templates/order-ticket-template.ts`). Docs updated in `docs/API_Endpoints.md`.
- âœ… **Customer deduplication & merge** â€” Duplicate detection by name, email, phone similarity with manual merge review UI in admin settings. Consolidates addresses, order history, and recipient relationships. Preserves all Stripe customer IDs via `ProviderCustomer` model (one-to-many relationship) for payment provider consolidation. Prevents self-referential relationships during merge (sender â‰  recipient validation). JSON import tool for bulk customer import with auto-duplicate detection and Stripe ID linking (`back/src/routes/customerDuplicates.ts`, `back/src/routes/import-json.ts`, `admin/src/app/components/settings/misc/ImportJsonCard.tsx`, `back/prisma/schema.prisma:1176-1181`). Docs updated in `docs/System_Reference.md`.
- âœ… **Wire product library** â€” Automated image fetching from Petals.ca wire product database with Cloudflare R2 auto-upload for persistence. Manual "Save to Library" workflow with modal for entering product code, name, description. Product code field optional but recommended. Image width standardized to 8 inches (768px) for print consistency. Wire product images automatically associated with FTD orders during import. Order.images array stores fetched/uploaded images across sessions (`back/src/routes/wire-products.ts`, `back/prisma/schema.prisma:1516-1530`, `admin/src/app/pages/FulfillmentPage.tsx`). Docs updated in `docs/System_Reference.md`.
- âœ… **Currency handling unified (cents)** â€” Frontend money state standardized to cents with shared `currency.ts` utilities; updated Take Order + POS flows, order edit/payment modals, reports, refunds, delivery views, and product pricing inputs (`admin/src/shared/utils/currency.ts`, `admin/src/app/components/orders/*`, `admin/src/app/components/pos/*`, `admin/src/app/components/refunds/RefundModal.tsx`, `admin/src/app/pages/reports/*`, `admin/src/app/components/products/*`).
- âœ… **Wire-out order system (2026-01-17)** â€” Full support for outgoing wire orders sent through relay services (FTD, Teleflora). Automatic zone detection triggers modal prompt when address is outside delivery zones. Province-aware tax calculation (BC: GST+PST 12%, other provinces: GST 5%, international: 0%). Unified settings page at `/settings/external-providers` combines wire-out configuration (service name, default fee) with external provider management (FTD, DoorDash incoming orders). Each order can independently be DELIVERY, PICKUP, or WIREOUT with appropriate tax/fee calculations. Database: Added `WIREOUT` to OrderType enum, `wireoutServiceFee`/`wireoutServiceName` fields to Order model, new `OperationsSettings` model. API: `/api/settings/operations` GET/PUT endpoints. UI: `WireoutSettingsCard`, `WireoutDetectionModal`, enhanced `RecipientCard` with zone detection (`back/prisma/schema.prisma:28-32,414-419,997-1005`, `back/src/routes/settings/operations.ts`, `admin/src/app/components/orders/RecipientCard.tsx`, `admin/src/app/components/orders/WireoutDetectionModal.tsx`, `admin/src/app/pages/settings/external-providers.tsx`, `admin/src/shared/utils/deliveryCalculations.ts`).
- âœ… **Employee unified auth (2026-01-24)** â€” Admin set/reset employee passwords, unified employee login status in Settings â†’ Business, header dropdown uses AuthContext, logout redirect, and change-password modal. API: `/api/employees/:id/set-password`, `/api/employees/:id/reset-password`. UI: `EmployeeListCard`, `SetPasswordModal`, `ChangePasswordModal`, `UserDropdown`.

### Variant Featured Images (2025-11-08)
- âœ… Database: Added `featuredImageUrl` to `ProductVariant` plus migration + Prisma client update.
- âœ… Backend: Product routes now read/write `featuredImageUrl` and include it in API responses.
- âœ… Admin UI: Pricing tiers now capture featured image per variant via dropdown + preview.
- âœ… Customer Website: Product gallery reorders images so the selected variant's photo shows first.

## ğŸ› ï¸ In Progress / Needs QA
- ğŸ› ï¸ **Split payments settlement** â€” UI is wired; needs backend distribution of PT lines and change logging (`admin/src/app/components/pos/payment/SplitPaymentView.tsx`, `back/src/routes/payment-transactions.ts`).
- ğŸ› ï¸ **Notification domain wiring** â€” `/api/notifications/*` endpoints still rely on placeholder repositories (`admin/src/domains/notifications/services/NotificationService.ts`).
- ğŸ› ï¸ **Order status history** â€” status transitions work, but `/api/orders/:id/history` remains a stub (`back/src/routes/orders/status.ts:101-162`).
- ğŸ› ï¸ **Event payments UX** â€” rich event payment flows exist, but modal polish + PDF outputs pending (`admin/src/app/pages/events/` components).
- âš ï¸ **Admin context in requests** â€” multiple TODOs note missing authenticated employee IDs when logging actions (e.g., `admin/src/domains/orders/services/OrderService.ts:148`).

## ğŸ”œ Backlog & Sequenced Work
- ğŸ”œ **TakeOrderPage UX polish** â€” iterate on existing full-page experience (section collapse, faster recipient search, clearer payment summary).
- ğŸ”œ **Draft cleanup after checkout** â€” auto-delete draft orders once PT transaction posts (`back/src/routes/orders/create.ts`, `back/src/routes/orders.ts`).
- ğŸ”œ **Customer portal launch** â€” build UI on top of `/api/customers/me/*` endpoints for order history & profile edits.
- ğŸ”œ **Delivery operations board** â€” driver assignment, routing, and live updates on top of `/api/orders/delivery`.
- ğŸ”œ **Rate limiting & audit logs** â€” complement existing auth lockouts and capture changes to sensitive settings.
- ğŸ”œ **Website (TailGrids) go-live** â€” reuse admin domains for storefront catalogue + checkout (`www/`).

## ğŸ“Œ Notes & Follow-ups
- TODOs across notification services highlight missing integrations; prioritize once Twilio/SendGrid credentials are stable.
- Coupon router under `back/src/routes/coupons` is legacy and not mounted â€” safe to ignore or remove after confirming no references.
- Order edit screen still carries placeholder mapping for payment adjustments (`admin/src/app/pages/orders/OrderEditPage.tsx`). Capture real data once transaction audit log is implemented.
- Keep an eye on `CustomerService.hashPassword` TODO for future consumer portal rollout (`admin/src/domains/customers/services/CustomerService.ts:209`).
