generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                       String              @id @default(uuid())
  name                     String
  slug                     String              @unique
  description              String
  categoryId               String
  reportingCategoryId      String
  recipeNotes              String?
  productType              ProductType         @default(MAIN)
  inventoryMode            InventoryMode       @default(OWN)
  visibility               Visibility          @default(BOTH)
  showOnHomepage           Boolean             @default(false)
  isActive                 Boolean             @default(true)
  isTaxable                Boolean             @default(true)
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  images                   String[]            @default([])
  availabilityType         String?             @default("always")
  holidayPreset            String?
  availableFrom            DateTime?
  availableTo              DateTime?
  notAvailableFrom         DateTime?
  notAvailableUntil        DateTime?
  isTemporarilyUnavailable Boolean             @default(false)
  unavailableUntil         DateTime?
  unavailableMessage       String?
  featuredAssetId          String?
  bundleComponents         BundleItem[]        @relation("BundleParent")
  includedInBundles        BundleItem[]        @relation("BundleChild")
  orderItems               OrderItem[]
  category                 Category            @relation("ProductCategory", fields: [categoryId], references: [id])
  reportingCategory        ReportingCategory   @relation("ProductReportingCategory", fields: [reportingCategoryId], references: [id])
  addonGroups              ProductAddOnGroup[]
  tags                     ProductTag[]
  categoryLinks            ProductCategoryLink[]
  variants                 ProductVariant[]
  eventItems               EventItem[]
}

model ProductVariant {
  id               String          @id @default(uuid())
  productId        String
  name             String
  sku              String          @unique
  price            Int
  priceDifference  Int?
  discountPrice    Int?
  stockLevel       Int?
  trackInventory   Boolean         @default(true)
  isDefault        Boolean         @default(false)
  isManuallyEdited Boolean         @default(false)
  featuredImageUrl String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  product          Product         @relation(fields: [productId], references: [id])
  options          VariantOption[]
}

model ProductOption {
  id              String               @id @default(uuid())
  name            String
  impactsVariants Boolean              @default(true)
  optionType      String?
  values          ProductOptionValue[]
}

model ProductOptionValue {
  id              String          @id @default(uuid())
  label           String
  optionId        String
  sortOrder       Int             @default(0)
  priceAdjustment Int?            @default(0)
  option          ProductOption   @relation(fields: [optionId], references: [id])
  variants        VariantOption[]
}

model VariantOption {
  id            String             @id @default(uuid())
  variantId     String
  optionValueId String
  optionValue   ProductOptionValue @relation(fields: [optionValueId], references: [id])
  variant       ProductVariant     @relation(fields: [variantId], references: [id])
}

model BundleItem {
  id                 String  @id @default(uuid())
  bundleProductId    String
  componentProductId String
  quantity           Int
  bundleProduct      Product @relation("BundleParent", fields: [bundleProductId], references: [id])
  componentProduct   Product @relation("BundleChild", fields: [componentProductId], references: [id])
}

model AddOnGroup {
  id        String              @id @default(uuid())
  name      String
  isDefault Boolean             @default(false)
  addOns    AddOnProduct[]
  products  ProductAddOnGroup[] @relation("ProductToAddOnGroup")
}

model AddOnProduct {
  id             String     @id @default(uuid())
  addonProductId String
  groupId        String
  group          AddOnGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([addonProductId, groupId])
}

model ProductAddOnGroup {
  id        String     @id @default(uuid())
  productId String
  groupId   String
  group     AddOnGroup @relation("ProductToAddOnGroup", fields: [groupId], references: [id], onDelete: Cascade)
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, groupId])
}

model Tag {
  id       String       @id @default(uuid())
  name     String       @unique
  products ProductTag[]
}

model ProductTag {
  id        String  @id @default(uuid())
  productId String
  tagId     String
  product   Product @relation(fields: [productId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])
}

model ProductCategoryLink {
  id         String   @id @default(uuid())
  productId  String
  categoryId String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

model Category {
  id        String     @id @default(uuid())
  name      String
  slug      String?    @unique
  parentId  String?
  level     Int        @default(1)
  sortOrder Int        @default(0)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @default(now()) @updatedAt
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]  @relation("ProductCategory")
  productLinks ProductCategoryLink[]

  @@unique([parentId, name])
}

model ReportingCategory {
  id       String    @id @default(uuid())
  name     String    @unique
  products Product[] @relation("ProductReportingCategory")
}

model Customer {
  id                  String               @id @default(cuid())
  firstName           String
  lastName            String
  email               String?              @unique
  phone               String?
  phoneLabel          String?              @default("Mobile")
  phoneNumbers        Json                 @default("[]")
  birthdayMonth       Int?
  birthdayDay         Int?
  birthdayYear        Int?
  birthdayOptIn       Boolean              @default(false)
  birthdayUpdatedAt   DateTime?
  notes               String?
  homeAddressId       String?              @unique
  password              String?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  isRegistered          Boolean              @default(false)
  lastLogin             DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  addresses           Address[]            @relation("MyAddresses")
  homeAddress         Address?             @relation("HomeAddress", fields: [homeAddressId], references: [id])
  ordersAsBuyer       Order[]              @relation("BuyerOrders")
  ordersAsRecipient   Order[]              @relation("RecipientOrders")
  savedBySenders      CustomerRecipient[]  @relation("Recipients")
  savedRecipients     CustomerRecipient[]  @relation("Senders")
  events              Event[]
  paymentTransactions PaymentTransaction[]
  providerCustomers   ProviderCustomer[]
  giftTokensRedeemed  GiftToken[]          @relation("RedeemedGiftTokens")
  paymentMethods      CustomerPaymentMethod[]
  discounts           Discount[]
  houseAccountLedger  HouseAccountLedger[]

  // House Account
  isHouseAccount      Boolean              @default(false)
  houseAccountTerms   String?              @default("NET_30")
  houseAccountNotes   String?

  // Cart sync across browsers
  cartData            Json?
  cartUpdatedAt       DateTime?

  @@index([phone])
  @@index([firstName, lastName])
}

model CustomerRecipient {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  createdAt   DateTime @default(now())
  recipient   Customer @relation("Recipients", fields: [recipientId], references: [id])
  sender      Customer @relation("Senders", fields: [senderId], references: [id])

  @@unique([senderId, recipientId])
  @@index([senderId])
  @@index([recipientId])
  @@map("customer_recipients")
}

model Address {
  id                  String       @id @default(cuid())
  label               String?
  firstName           String?
  lastName            String?
  address1            String
  address2            String?
  city                String
  province            String
  postalCode          String
  country             String       @default("CA")
  phone               String?
  company             String?      @db.VarChar(255)
  addressType         AddressType? @default(RESIDENCE)
  customerId          String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @default(now()) @updatedAt
  customer            Customer?    @relation("MyAddresses", fields: [customerId], references: [id])
  homeOf              Customer?    @relation("HomeAddress")
  ordersDeliveredHere Order[]      @relation("DeliveryAddress")

  @@index([country])
  @@index([customerId])
}

model Order {
  id                  String               @id @default(cuid())
  orderNumber         Int                  @unique @default(autoincrement())
  type                OrderType
  status              OrderStatus          @default(DRAFT)
  orderSource         OrderSource          @default(PHONE)
  externalSource      OrderExternalSource?
  externalReference   String?              @unique
  importedPayload     Json?
  externalStatus      String?
  needsExternalUpdate Boolean              @default(false)
  images              String[]             @default([])
  additionalPhones    String[]             @default([])
  customerId          String?
  recipientCustomerId String?
  deliveryAddressId   String?
  employeeId          String?
  cardMessage         String?
  specialInstructions String?
  occasion            String?
  deliveryDate        DateTime?
  deliveryTime        String?
  deliveryFee         Int                  @default(0)
  discount            Int                  @default(0)
  couponCode          String?
  couponId            String?
  discountId          String?
  discountCode        String?
  discountBreakdown   Json                 @default("[]")
  taxBreakdown        Json                 @default("[]")
  totalTax            Int                  @default(0)
  gst                 Int                  @default(0)
  pst                 Int                  @default(0)
  paymentAmount       Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  recipientId         String?
  recipientName       String?
  wireoutServiceFee   Int?
  wireoutServiceName  String?
  coupon              Coupon?              @relation(fields: [couponId], references: [id])
  customer            Customer?            @relation("BuyerOrders", fields: [customerId], references: [id])
  deliveryAddress     Address?             @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  appliedDiscount     Discount?            @relation(fields: [discountId], references: [id])
  employee            Employee?            @relation("EmployeeOrders", fields: [employeeId], references: [id])
  recipientCustomer   Customer?            @relation("RecipientOrders", fields: [recipientCustomerId], references: [id])
  orderItems          OrderItem[]
  printJobs           PrintJob[]
  giftTokens          GiftToken[]
  routeStop           RouteStop?           @relation("RouteStopOrder")
  communications      OrderCommunication[]
  orderPayments       OrderPayment[]
  orderRefunds        OrderRefund[]
  houseAccountLedger  HouseAccountLedger[]

  @@index([createdAt])
  @@index([status])
  @@index([orderSource])
  @@index([externalSource])
}

model Route {
  id          String      @id @default(uuid())
  routeNumber Int         @unique @default(autoincrement())
  name        String?
  date        DateTime
  driverId    String?
  status      RouteStatus @default(PLANNED)
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  driver      Employee?   @relation("DriverRoutes", fields: [driverId], references: [id])
  stops       RouteStop[]

  @@index([date])
  @@index([driverId])
  @@index([status])
}

model RouteStop {
  id            String     @id @default(uuid())
  routeId       String
  orderId       String     @unique
  sequence      Int
  status        StopStatus @default(PENDING)
  arrivedAt     DateTime?
  deliveredAt   DateTime?
  driverNotes   String?
  signatureUrl  String?
  photoUrl      String?
  recipientName String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  order         Order      @relation("RouteStopOrder", fields: [orderId], references: [id])
  route         Route      @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([routeId, sequence])
  @@index([routeId])
  @@index([orderId])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String?
  customName  String?
  unitPrice   Int
  quantity    Int
  rowTotal    Int
  description String?
  order       Order    @relation(fields: [orderId], references: [id])
  product     Product? @relation(fields: [productId], references: [id])
}

model OrderCommunication {
  id           String            @id @default(uuid())
  orderId      String
  employeeId   String?
  type         CommunicationType
  status       String?
  quickActions String[]          @default([])
  message      String
  recipient    String?
  subject      String?
  isAutomatic  Boolean           @default(false)
  sentVia      String?
  createdAt    DateTime          @default(now())
  readAt       DateTime?
  employee     Employee?         @relation(fields: [employeeId], references: [id])
  order        Order             @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@map("order_communications")
}

model Coupon {
  id                   String        @id @default(uuid())
  code                 String        @unique
  name                 String
  description          String?
  discountType         String
  value                Int
  usageLimit           Int?
  usageCount           Int           @default(0)
  perCustomerLimit     Int?
  startDate            DateTime?
  endDate              DateTime?
  minimumOrder         Int?
  applicableProducts   String[]      @default([])
  applicableCategories String[]      @default([])
  posOnly              Boolean       @default(false)
  webOnly              Boolean       @default(false)
  enabled              Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  usages               CouponUsage[]
  orders               Order[]
  giftTokens           GiftToken[]
}

model CouponUsage {
  id         String   @id @default(uuid())
  couponId   String
  customerId String?
  orderId    String?
  employeeId String?
  source     String
  usedAt     DateTime @default(now())
  coupon     Coupon   @relation(fields: [couponId], references: [id])
}

model GiftToken {
  id                    String           @id @default(uuid())
  token                 String           @unique
  type                  GiftTokenType    @default(BIRTHDAY_RECIPIENT_GIFT)
  status                GiftTokenStatus  @default(ACTIVE)
  expiresAt             DateTime?
  issuedForOrderId      String?
  issuedForOrder        Order?           @relation(fields: [issuedForOrderId], references: [id])
  issuedToRecipientName String?
  redeemedAt            DateTime?
  redeemedByCustomerId  String?
  redeemedByCustomer    Customer?        @relation("RedeemedGiftTokens", fields: [redeemedByCustomerId], references: [id])
  couponId              String?
  coupon                Coupon?          @relation(fields: [couponId], references: [id])
  metadata              Json?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([token])
  @@index([status])
}

model Discount {
  id                   String          @id @default(uuid())
  code                 String?         @unique
  name                 String
  description          String?
  discountType         DiscountType
  triggerType          TriggerType
  value                Int
  applicableProducts   String[]        @default([])
  applicableCategories String[]        @default([])
  minimumQuantity      Int?
  maximumQuantity      Int?
  minimumOrder         Int?
  buyXGetYFree         Json?
  autoApply            Boolean         @default(false)
  priority             Int             @default(1)
  stackable            Boolean         @default(false)
  usageLimit           Int?
  usageCount           Int             @default(0)
  perCustomerLimit     Int?
  periodLimit          Int?
  periodType           PeriodType?
  periodWindowDays     Int?
  customerId           String?
  customer             Customer?       @relation(fields: [customerId], references: [id])
  startDate            DateTime?
  endDate              DateTime?
  posOnly              Boolean         @default(false)
  webOnly              Boolean         @default(false)
  enabled              Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  usages               DiscountUsage[]
  orders               Order[]

  @@index([discountType])
  @@index([triggerType])
  @@index([enabled])
  @@index([startDate, endDate])
  @@index([customerId])
}

model DiscountUsage {
  id           String   @id @default(uuid())
  discountId   String
  customerId   String?
  orderId      String?
  employeeId   String?
  source       String
  appliedValue Int
  usedAt       DateTime @default(now())
  discount     Discount @relation(fields: [discountId], references: [id])
}

model AddressShortcut {
  type         ShortcutType
  id           String       @id @default(cuid())
  label        String
  address1     String
  address2     String?
  city         String
  province     String
  postalCode   String
  country      String       @default("CA")
  phoneNumbers String[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  @@index([country])
  @@index([type])
}

model Employee {
  id                  String               @id @default(cuid())
  name                String
  email               String?              @unique
  phone               String?
  type                EmployeeType         @default(CASHIER)
  isActive            Boolean              @default(true)
  password            String?
  lastLogin           DateTime?
  failedLoginAttempts Int                  @default(0)
  accountLockedUntil  DateTime?
  orders              Order[]              @relation("EmployeeOrders")
  routes              Route[]              @relation("DriverRoutes")
  eventPayments       EventPayment[]
  events              Event[]
  communications      OrderCommunication[]
  paymentTransactions PaymentTransaction[] @relation("EmployeeTransactions")
  refunds             Refund[]             @relation("EmployeeRefunds")
}

model MessageSuggestion {
  id      String @id @default(cuid())
  label   String
  message String
}

model PaymentSettings {
  id                  String              @id @default(cuid())
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  defaultCardProvider PaymentProvider?
  stripeEnabled       Boolean             @default(false)
  stripeMode          PaymentProviderMode @default(TERMINAL)
  stripePublicKey     String?
  stripeSecretKey     String?
  stripeTerminalId    String?
  stripeAccountId     String?
  squareEnabled       Boolean             @default(false)
  squareMode          PaymentProviderMode @default(TERMINAL)
  squareAppId         String?
  squareAccessToken   String?
  squareLocationId    String?
  squareTerminalId    String?
  paypalEnabled       Boolean             @default(false)
  paypalEnvironment   String?
  paypalClientId      String?
  paypalClientSecret  String?
  allowSplitPayments  Boolean             @default(true)
  allowOfflineNotes   Boolean             @default(true)
  codEnabled          Boolean             @default(false)
  houseAccountEnabled Boolean             @default(false)
  checkEnabled        Boolean             @default(false)

  @@map("payment_settings")
}

model OfflinePaymentMethod {
  id                  String          @id @default(cuid())
  name                String
  code                String          @unique
  description         String?
  instructions        String?
  isActive            Boolean         @default(true)
  visibleOnPos        Boolean         @default(true)
  visibleOnTakeOrder  Boolean         @default(true)
  requiresReference   Boolean         @default(false)
  allowChangeTracking Boolean         @default(false)
  sortOrder           Int             @default(0)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  paymentMethods      PaymentMethod[]

  @@map("offline_payment_methods")
}

model StoreSettings {
  id        String   @id @default(cuid())
  storeName String
  phone     String
  email     String
  address   String
  city      String
  state     String
  zipCode   String
  country   String   @default("CA")
  taxId     String?
  currency  String   @default("CAD")
  timezone  String   @default("America/Vancouver")
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("store_settings")
}

model BusinessHoursSettings {
  id               String   @id @default(cuid())
  timezone         String   @default("America/Vancouver")
  mondayOpen       String?
  mondayClose      String?
  mondayEnabled    Boolean  @default(true)
  tuesdayOpen      String?
  tuesdayClose     String?
  tuesdayEnabled   Boolean  @default(true)
  wednesdayOpen    String?
  wednesdayClose   String?
  wednesdayEnabled Boolean  @default(true)
  thursdayOpen     String?
  thursdayClose    String?
  thursdayEnabled  Boolean  @default(true)
  fridayOpen       String?
  fridayClose      String?
  fridayEnabled    Boolean  @default(true)
  saturdayOpen     String?
  saturdayClose    String?
  saturdayEnabled  Boolean  @default(true)
  sundayOpen       String?
  sundayClose      String?
  sundayEnabled    Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("business_hours_settings")
}

model DeliveryExceptions {
  id         String   @id @default(cuid())
  exceptions Json[]
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("delivery_exceptions")
}

model Holiday {
  id          String   @id @default(cuid())
  name        String
  startDate   String
  endDate     String
  isOpen      Boolean  @default(false)
  openTime    String?
  closeTime   String?
  isRecurring Boolean  @default(false)
  color       String   @default("red")
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("holidays")
}

model DeliveryZone {
  id          String   @id @default(cuid())
  name        String
  minDistance Float
  maxDistance Float?
  fee         Int
  enabled     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("delivery_zones")
}

model DeliverySettings {
  id                  String   @id @default(cuid())
  storeAddress        String
  storePostalCode     String?
  storeLatitude       Float?
  storeLongitude      Float?
  deliveryMode        String   @default("DISTANCE")
  freeDeliveryMinimum Int?
  maxDeliveryRadius   Float?
  enabled             Boolean  @default(true)
  businessHoursOnly   Boolean  @default(true)
  advanceOrderHours   Int      @default(2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("delivery_settings")
}

model DeliveryPostalZone {
  id          String   @id @default(cuid())
  name        String
  postalCodes String[]
  fee         Int
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("delivery_postal_zones")
}

model DeliveryRegionZone {
  id        String   @id @default(cuid())
  name      String
  cities    String[]
  provinces String[]
  fee       Int
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("delivery_region_zones")
}

model GiftCard {
  id             String                @id @default(uuid())
  cardNumber     String                @unique
  type           String
  initialValue   Int                   @default(0)
  currentBalance Int                   @default(0)
  purchasedBy    String?
  recipientEmail String?
  recipientName  String?
  message        String?
  status         String                @default("INACTIVE")
  expirationDate DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  transactions   GiftCardTransaction[]
}

model GiftCardTransaction {
  id           String   @id @default(uuid())
  giftCardId   String
  orderId      String?
  type         String
  amount       Int
  balanceAfter Int
  notes        String?
  employeeId   String?
  createdAt    DateTime @default(now())
  giftCard     GiftCard @relation(fields: [giftCardId], references: [id])
}

model POSSettings {
  id         String   @id @default(cuid())
  tabs       Json
  defaultTab String?  @map("default_tab")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("pos_settings")
}

model OperationsSettings {
  id                 String   @id @default(cuid())
  wireoutServiceFee  Int      @default(1500)
  wireoutServiceName String   @default("FTD")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("operations_settings")
}

model PrintSettings {
  id        String   @id @default(cuid())
  storeId   String?  @unique

  // Receipts (Thermal/POS - in-person sales)
  receiptsEnabled     Boolean @default(true)
  receiptsDestination String  @default("browser")
  receiptsCopies      Int     @default(1)
  receiptsPrinterName String?
  receiptsPrinterTray Int?

  // Order Tickets (Delivery tags - flower orders)
  ticketsEnabled     Boolean @default(true)
  ticketsDestination String  @default("electron-agent")
  ticketsPrinterName String?
  ticketsPrinterTray Int?    @default(1)

  // Documents (Invoices + Reports - general printing)
  documentsEnabled     Boolean @default(true)
  documentsDestination String  @default("browser")
  documentsPrinterName String?
  documentsPrinterTray Int?    @default(2)

  // Labels (Price tags - inventory)
  labelsEnabled     Boolean @default(true)
  labelsDestination String  @default("electron-agent")
  labelsPrinterName String?
  labelsPrinterTray Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("print_settings")
}

model EmailSettings {
  id String @id @default(cuid())

  // Email Provider
  provider String  @default("sendgrid")
  enabled  Boolean @default(true)

  // SendGrid
  apiKey String?

  // SMTP
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPassword String?

  // From Settings
  fromEmail String @default("noreply@hellobloom.ca")
  fromName  String @default("Bloom Flowers")

  // SMS/Twilio Settings
  smsEnabled       Boolean @default(false)
  twilioAccountSid String?
  twilioAuthToken  String?
  twilioPhoneNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_settings")
}

model TransactionCounter {
  id           String @id @default(cuid())
  currentValue Int    @default(0)
  prefix       String @default("PT")

  @@map("transaction_counter")
}

model PaymentTransaction {
  id                String                   @id @default(uuid())
  transactionNumber String                   @unique
  status            PaymentTransactionStatus @default(PENDING)
  channel           PaymentChannel
  totalAmount       Int                      @default(0)
  taxAmount         Int                      @default(0)
  tipAmount         Int                      @default(0)
  customerId        String
  employeeId        String?
  notes             String?
  receiptSent       Boolean                  @default(false)
  receiptEmail      String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  completedAt       DateTime?
  orderPayments     OrderPayment[]
  paymentMethods    PaymentMethod[]
  customer          Customer                 @relation(fields: [customerId], references: [id])
  employee          Employee?                @relation("EmployeeTransactions", fields: [employeeId], references: [id])
  refunds           Refund[]
  houseAccountLedger HouseAccountLedger[]

  @@index([createdAt])
  @@index([status])
  @@index([customerId])
  @@map("payment_transactions")
}

model PaymentMethod {
  id                    String                @id @default(uuid())
  transactionId         String
  type                  PaymentMethodType
  provider              PaymentProvider
  amount                Int
  offlineMethodId       String?
  providerTransactionId String?
  providerMetadata      Json?
  cardLast4             String?
  cardBrand             String?
  giftCardNumber        String?
  checkNumber           String?
  status                String                @default("completed")
  processedAt           DateTime              @default(now())
  paymentSource         String?               @default("MANUAL")
  isCardPresent         Boolean               @default(false)
  offlineMethod         OfflinePaymentMethod? @relation(fields: [offlineMethodId], references: [id])
  transaction           PaymentTransaction    @relation(fields: [transactionId], references: [id])

  @@map("payment_methods")
}

model OrderPayment {
  id            String             @id @default(uuid())
  transactionId String
  orderId       String
  amount        Int
  order         Order              @relation(fields: [orderId], references: [id])
  transaction   PaymentTransaction @relation(fields: [transactionId], references: [id])

  @@map("order_payments")
}

model HouseAccountLedger {
  id            String                 @id @default(uuid())
  customerId    String
  customer      Customer               @relation(fields: [customerId], references: [id])
  type          HouseAccountEntryType
  amount        Int
  balance       Int
  description   String
  reference     String?
  orderId       String?
  order         Order?                 @relation(fields: [orderId], references: [id])
  transactionId String?
  transaction   PaymentTransaction?    @relation(fields: [transactionId], references: [id])
  createdAt     DateTime               @default(now())
  createdBy     String?

  @@index([customerId])
  @@index([createdAt])
}

model Refund {
  id                  String             @id @default(uuid())
  transactionId       String
  refundNumber        String             @unique
  amount              Int
  reason              String?
  employeeId          String?
  processedAt         DateTime           @default(now())
  refundType          String             @default("FULL")
  itemBreakdown       Json?
  taxRefunded         Int                @default(0)
  deliveryFeeRefunded Int                @default(0)
  orderRefunds        OrderRefund[]
  refundMethods       RefundMethod[]
  employee            Employee?          @relation("EmployeeRefunds", fields: [employeeId], references: [id])
  transaction         PaymentTransaction @relation(fields: [transactionId], references: [id])

  @@map("refunds")
}

model RefundMethod {
  id                String            @id @default(uuid())
  refundId          String
  paymentMethodType PaymentMethodType
  provider          PaymentProvider
  amount            Int
  providerRefundId  String?
  status            String            @default("completed")
  refund            Refund            @relation(fields: [refundId], references: [id])

  @@map("refund_methods")
}

model OrderRefund {
  id       String @id @default(uuid())
  refundId String
  orderId  String
  amount   Int
  order    Order  @relation(fields: [orderId], references: [id])
  refund   Refund @relation(fields: [refundId], references: [id])

  @@map("order_refunds")
}

model ExternalProvider {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("external_providers")
}

model TaxRate {
  id          String   @id @default(cuid())
  name        String
  rate        Float
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(1)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([isActive])
  @@index([sortOrder])
  @@map("tax_rates")
}

model NotificationSettings {
  id        String   @id @default(cuid())
  type      String   @unique
  settings  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_settings")
}

model ProviderCustomer {
  id                 String          @id @default(uuid())
  customerId         String
  provider           PaymentProvider
  providerCustomerId String
  providerEmail      String?
  providerMetadata   Json?
  isActive           Boolean         @default(true)
  lastSyncAt         DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  isPrimary          Boolean         @default(false)
  customer           Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([provider, providerCustomerId])
  @@index([customerId])
  @@index([customerId, provider])
  @@index([provider, providerCustomerId])
  @@map("provider_customers")
}

model CustomerPaymentMethod {
  id                    String   @id @default(uuid())
  customerId            String
  customer              Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  stripePaymentMethodId String?
  stripeCustomerId      String?
  cardFingerprint       String
  last4                 String
  brand                 String
  expMonth              Int
  expYear               Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([cardFingerprint])
  @@index([customerId])
}

model Event {
  id                String         @id @default(uuid())
  eventNumber       Int            @unique @default(autoincrement())
  eventType         EventType
  eventName         String
  description       String?
  customerId        String
  eventDate         DateTime
  setupDate         DateTime?
  setupTime         String?
  venue             String
  venueAddress      String?
  contactPerson     String?
  contactPhone      String?
  estimatedGuests   Int?
  serviceType       String?
  status            EventStatus    @default(INQUIRY)
  quotedAmount      Int?
  finalAmount       Int?
  employeeId        String?
  designNotes       String?
  setupNotes        String?
  internalNotes     String?
  customerNotes     String?
  lastContactDate   DateTime?
  quoteEmailSent    Boolean        @default(false)
  quoteEmailDate    DateTime?
  inspirationPhotos String[]       @default([])
  quotePhotos       String[]       @default([])
  finalPhotos       String[]       @default([])
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  completedAt       DateTime?
  items             EventItem[]
  payments          EventPayment[]
  customer          Customer       @relation(fields: [customerId], references: [id])
  employee          Employee?      @relation(fields: [employeeId], references: [id])

  @@index([eventType])
  @@index([status])
  @@index([eventDate])
  @@index([customerId])
  @@map("events")
}

model EventItem {
  id              String    @id @default(uuid())
  eventId         String
  category        String
  description     String
  quantity        Int       @default(1)
  unitPrice       Int
  totalPrice      Int
  productionNotes String?
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  productId       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  product         Product?  @relation(fields: [productId], references: [id])

  @@map("event_items")
}

model EventPayment {
  id           String             @id @default(uuid())
  eventId      String
  amount       Int
  paymentType  EventPaymentType
  status       EventPaymentStatus @default(PENDING)
  description  String?
  reference    String?
  notes        String?
  employeeId   String?
  dueDate      DateTime?
  receivedDate DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  employee     Employee?          @relation(fields: [employeeId], references: [id])
  event        Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@map("event_payments")
}

model PrintJob {
  id           String         @id @default(cuid())
  type         PrintJobType
  status       PrintJobStatus @default(PENDING)
  agentType    String?
  printerName  String?
  printerTray  Int?
  copies       Int            @default(1)
  orderId      String?
  data         Json
  template     String
  priority     Int            @default(0)
  agentId      String?
  errorMessage String?
  createdAt    DateTime       @default(now())
  printedAt    DateTime?
  updatedAt    DateTime       @updatedAt
  order        Order?         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt])
  @@index([orderId])
  @@index([agentId])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  position  Int      @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HomepageSettings {
  id                 String   @id @default(cuid())
  announcementBanner Json
  updatedAt          DateTime @updatedAt
}

model ShopProfile {
  id                 String   @id @default(cuid())
  googleGeminiApiKey String?
  settings           Json?    @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  googleMapsApiKey   String?

  @@map("shop_profile")
}

model WireProductLibrary {
  id          String    @id @default(cuid())
  productCode String    @unique
  productName String?
  description String?
  imageUrl    String?
  source      String?
  externalUrl String?
  timesUsed   Int       @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([productCode])
  @@index([source])
}

enum ProductType {
  MAIN
  ADDON
  SERVICE
}

enum InventoryMode {
  NONE
  OWN
  BUNDLE
}

enum Visibility {
  ONLINE
  POS
  BOTH
}

enum OrderType {
  DELIVERY
  PICKUP
  WIREOUT
  GIFT_CARD
}

enum OrderStatus {
  DRAFT
  PAID
  IN_DESIGN
  READY
  OUT_FOR_DELIVERY
  COMPLETED
  REJECTED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum OrderSource {
  PHONE
  WALKIN
  EXTERNAL
  WEBSITE
  POS
}

enum OrderExternalSource {
  FTD
  DOORDASH
  FUNERAL_SERVICE
  OTHER
}

enum PrintJobType {
  RECEIPT
  ORDER_TICKET
  REPORT
  LABEL
}

enum PrintJobStatus {
  PENDING
  PRINTING
  COMPLETED
  FAILED
}

enum RouteStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StopStatus {
  PENDING
  EN_ROUTE
  ARRIVED
  DELIVERED
  ATTEMPTED
  SKIPPED
}

enum EmployeeType {
  CASHIER
  DESIGNER
  DRIVER
  ADMIN
}

enum ShortcutType {
  CHURCH
  FUNERAL_HOME
  SCHOOL
  HOSPITAL
  OTHER
}

enum AddressType {
  RESIDENCE
  BUSINESS
  CHURCH
  SCHOOL
  FUNERAL_HOME
  OTHER
}

enum CommunicationType {
  PHONE_CALL
  SMS_SENT
  SMS_RECEIVED
  EMAIL_SENT
  NOTE
}

enum DiscountType {
  FIXED_AMOUNT
  PERCENTAGE
  FREE_SHIPPING
  SALE_PRICE
  BUY_X_GET_Y_FREE
}

enum TriggerType {
  COUPON_CODE
  AUTOMATIC_PRODUCT
  AUTOMATIC_CATEGORY
}

enum PeriodType {
  WEEKLY
  MONTHLY
  YEARLY
}

enum PaymentProviderMode {
  TERMINAL
  MANUAL
  HYBRID
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum PaymentMethodType {
  CASH
  CARD
  GIFT_CARD
  STORE_CREDIT
  CHECK
  COD
  HOUSE_ACCOUNT
  OFFLINE
  EXTERNAL
}

enum HouseAccountEntryType {
  CHARGE
  PAYMENT
  ADJUSTMENT
}

enum PaymentProvider {
  STRIPE
  SQUARE
  PAYPAL
  INTERNAL
}

enum PaymentChannel {
  POS
  PHONE
  WEBSITE
}

enum EventType {
  WEDDING
  CORPORATE
  BIRTHDAY
  ANNIVERSARY
  FUNERAL
  GRADUATION
  OTHER
}

enum EventStatus {
  INQUIRY
  QUOTE_REQUESTED
  QUOTE_SENT
  QUOTE_APPROVED
  DEPOSIT_RECEIVED
  IN_PRODUCTION
  READY_FOR_INSTALL
  INSTALLED
  COMPLETED
  CANCELLED
  REJECTED
}

enum EventPaymentType {
  CASH
  CHECK
  BANK_TRANSFER
  POS_SYSTEM
  CREDIT_CARD
  OTHER
}

enum EventPaymentStatus {
  PENDING
  RECEIVED
  FAILED
  REFUNDED
}

enum GiftTokenType {
  BIRTHDAY_RECIPIENT_GIFT
}

enum GiftTokenStatus {
  ACTIVE
  CLAIMED
  REDEEMED
  EXPIRED
  REVOKED
}
